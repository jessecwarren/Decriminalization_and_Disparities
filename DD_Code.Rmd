---
title: "DD_Code"
author: "Jesse Warren"
date: "10/20/2019"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(tidycensus)
library(readxl)
```


```{r load UCR data, cache=TRUE}
#loop to load data
UCR_files <- list.files("Data/UCR", pattern = ".tsv$", recursive = TRUE)
UCR_files <- UCR_files[-which(str_detect(UCR_files, "UCR_2015"))] #remove 2015, because it doesnt have yearly summarized data, and needs to be dealt with separately
UCR_data_list <- vector("list", length(UCR_files))
UCR_data_names <- stringr::str_sub(UCR_files, 1, 8)
names(UCR_data_list) <- UCR_data_names
for (i in seq_along(UCR_files)){
  UCR_data_list[[UCR_data_names[i]]] <- read_tsv(paste0("Data/UCR/", UCR_files[i]))
}
head(UCR_data_list[[1]])

#check that colnames are the same
colnames(UCR_data_list[[1]]) == colnames(UCR_data_list[[2]])


#load 2015 separately, calculate


```

```{r load ACS state population data, cache=TRUE}

#load variable list
vlist <- load_variables(2016, "acs5", cache = TRUE)

#load ACS state population data
pop_ACS_years <- lst(2009, 2010, 2011, 2012, 2013, 2014, 2015, 2016)

ACS_state_pops <- map_dfr(
  pop_ACS_years, 
  ~ get_acs(geography = "state", variables = c(total_pop = "B03002_001", white_pop = "B03002_003", black_pop = "B03002_004"),
            year = .x, output = "wide"),
  .id = "year") %>% 
  select(-total_popM) %>% 
  arrange(year, GEOID)
```

```{r Explore UCR Marijuana data}


UCR_Data_2013_raw %>% 
  select(STATE, ORI, YEAR, REPORT, ADJUST, POP, COUNTY, AGENCY, CARD1, CARD2, CARD3, OFFENSE, JW, JB, JI, JA, JH, JN, AW, AB, AI, AA, AH, AN) %>% 
  filter(STATE == "(46) Washington") %>% #only include WA
  filter(OFFENSE == 182 | OFFENSE == 187) %>%  #only include marijuana sale (182) or marijuana possession (187)
  head()

UCR_Data_2013_raw %>% 
  select(STATE, ORI, YEAR, REPORT, ADJUST, POP, COUNTY, AGENCY, CARD1, CARD2, CARD3, OFFENSE, JW, JB, JI, JA, JH, JN, AW, AB, AI, AA, AH, AN) %>% 
  filter(STATE == "(50) Alaska") %>% #only include AK
  filter(OFFENSE == 182 | OFFENSE == 187) %>%  #only include marijuana sale (182) or marijuana possession (187) 
  head()
```

```{r Explore statewide arrest totals and rates for one year}
UCR_data_list$UCR_2016 %>% 
  group_by(STNAME) %>% 
  filter(OFFENSE != 998, OFFENSE != 000) %>% 
  summarize(total_arrests_race_data = (sum(AW) + sum(AB) + sum(AI) + sum(AA) + sum(JW) + sum(JB) + sum(JI) + sum(JA)),
            pct_African_American_arrests = (sum(AB) + sum(JB)) / (sum(AW) + sum(AB) + sum(AI) + sum(AA) + sum(JW) + sum(JB) + sum(JI) + sum(JA)),
            pct_White_arrests = (sum(AW)+ sum(JW)) / (sum(AW) + sum(AB) + sum(AI) + sum(AA) + sum(JW) + sum(JB) + sum(JI) + sum(JA)))


#calculate % of marijuana arrests that are african american, white
UCR_data_list$UCR_2016 %>% 
  group_by(STNAME) %>% 
  filter(OFFENSE == 182 | OFFENSE == 187) %>%  #only include marijuana sale (182) or marijuana possession (187) 
  summarize(total_marijuana_arrests_race_data = (sum(AW) + sum(AB) + sum(AI) + sum(AA) + sum(JW) + sum(JB) + sum(JI) + sum(JA)),
            pct_African_American_marijuana_arrests = (sum(AB) + sum(JB)) / (sum(AW) + sum(AB) + sum(AI) + sum(AA) + sum(JW) + sum(JB) + sum(JI) + sum(JA)),
            pct_White_marijuana_arrests = (sum(AW) + sum(JW)) / (sum(AW) + sum(AB) + sum(AI) + sum(AA) + sum(JW) + sum(JB) + sum(JI) + sum(JA)))

#calculate % of non-violent, non-drug related misdemeanor arrests that are african american, white. These include:
  #140 = Vandalism
  #220 = Liquor Laws
  #230 = Drunkennes
  #240 = Disorderly Conduct
  #250 = Vagrancy
  #270 = Suspicion
  #280 = Curfew and loitering violations
UCR_data_list$UCR_2016 %>% 
  group_by(STNAME) %>% 
  filter(OFFENSE == 140 | OFFENSE == 220 | OFFENSE == 230 | OFFENSE == 240 | OFFENSE == 250 | OFFENSE == 270 | OFFENSE == 280) %>%
  summarize(total_non_violent_non_drug_misdemeanor_arrests_race_data = (sum(AW) + sum(AB) + sum(AI) + sum(AA) + sum(JW) + sum(JB) + sum(JI) + sum(JA)),
            pct_African_American_non_violent_non_drug_misdemeano_arrests = (sum(AB) + sum(JB)) / (sum(AW) + sum(AB) + sum(AI) + sum(AA) + sum(JW) + sum(JB) + sum(JI) + sum(JA)),
            pct_White_non_violent_non_drug_misdemeano_arrests = (sum(AW) + sum(JW)) / (sum(AW) + sum(AB) + sum(AI) + sum(AA) + sum(JW) + sum(JB) + sum(JI) + sum(JA)))
```



```{r calculate statewide arrest totals and rates for all years and loop into list}

#race categories
  # AW = Adult White
  # AB = Adult Black
  # AI = Adult Indian
  # AA = Adult Asian
  # JW = Juvenile White
  # JB = Juvenile Black
  # JI = Juvenile Indian
  # JA = Juvenile Asian
#ethnicity categories
  # AH = Adult Hispanic
  # AN = Adult Non-Hispanic
  # JH = Juvenile Hispanic
  # JN = Juvenile Non-Hispanic



#state arrest totals and rates list
UCR_arrest_totals_and_rates <- vector("list", length(UCR_data_list))
names(UCR_arrest_totals_and_rates) <- names(UCR_data_list)


for(i in 1:length(UCR_data_list)){
  #calculate % of total arrests that are african american, white
  UCR_arrest_totals_and_rates[[i]] <- UCR_data_list[[i]] %>% 
    group_by(STNAME, STATE) %>% 
    filter(OFFENSE != 998, OFFENSE != 000) %>% 
    summarize(total_arrests_race_data = (sum(AW) + sum(AB) + sum(AI) + sum(AA) + sum(JW) + sum(JB) + sum(JI) + sum(JA)),
              total_White_arrests = (sum(AW) + sum(JW)),
              total_African_American_arrests = (sum(AB) + sum(JB)),
              pct_arrests_White = total_White_arrests / total_arrests_race_data,
              pct_arrests_African_American = total_African_American_arrests / total_arrests_race_data) %>%
    arrange(STATE)
    
  
  #calculate % of marijuana arrests that are african american, white
  UCR_arrest_totals_and_rates[[i]] <- full_join(UCR_arrest_totals_and_rates[[i]],
    UCR_data_list[[i]] %>% 
      group_by(STATE) %>% 
      filter(OFFENSE == 182 | OFFENSE == 187) %>%  #only include marijuana sale (182) or marijuana possession (187) 
      summarize(total_marijuana_arrests_race_data = (sum(AW) + sum(AB) + sum(AI) + sum(AA) + sum(JW) + sum(JB) + sum(JI) + sum(JA)),
                total_White_marijuana_arrests = (sum(AW) + sum(JW)),
                total_African_American_marijuana_arrests = (sum(AB) + sum(JB)),
                pct_marijuana_arrests_White = total_White_marijuana_arrests / total_marijuana_arrests_race_data,
                pct_marijuana_arrests_African_American = total_African_American_marijuana_arrests / total_marijuana_arrests_race_data) %>% 
      arrange(STATE), 
    by = "STATE")
  
  #calculate % of non-violent, non-drug related misdemeanor arrests that are african american, white. These include:
    #140 = Vandalism
    #220 = Liquor Laws
    #230 = Drunkennes
    #240 = Disorderly Conduct
    #250 = Vagrancy
    #270 = Suspicion
    #280 = Curfew and loitering violations
  UCR_arrest_totals_and_rates[[i]] <- full_join(UCR_arrest_totals_and_rates[[i]],
    UCR_data_list[[i]] %>% 
      group_by(STATE) %>% 
      filter(OFFENSE == 140 | OFFENSE == 220 | OFFENSE == 230 | OFFENSE == 240 | OFFENSE == 250 | OFFENSE == 270 | OFFENSE == 280) %>%
      summarize(total_non_violent_non_drug_misdemeanor_arrests_race_data = (sum(AW) + sum(AB) + sum(AI) + sum(AA) + sum(JW) + sum(JB) + sum(JI) + sum(JA)),
                total_White_non_drug_misdemeanor_arrests = (sum(AW) + sum(JW)),
                total_African_American_non_drug_misdemeanor_arrests = (sum(AB) + sum(JB)),
                pct_non_violent_non_drug_misdemeano_arrests_White = total_White_non_drug_misdemeanor_arrests / total_non_violent_non_drug_misdemeanor_arrests_race_data,
                pct_non_violent_non_drug_misdemeano_arrests_African_American = total_African_American_non_drug_misdemeanor_arrests / total_non_violent_non_drug_misdemeanor_arrests_race_data) %>% 
      arrange(STATE), 
    by = "STATE")
}  

#bind into one df
UCR_arrest_totals_and_rates <- bind_rows(UCR_arrest_totals_and_rates, .id = "column_label")
```

```{r Combine state pop and arrest data}
#load sheet with matched names
state_name_matching_key <- read_excel("State_Name_Matching.xlsx")
UCR_arrest_totals_and_rates <- full_join(UCR_arrest_totals_and_rates, state_name_matching_key, by = "STNAME")

#create year column
UCR_arrest_totals_and_rates <- UCR_arrest_totals_and_rates %>% 
  mutate(year = str_sub(column_label, start = -4)) %>% 
  select(-column_label)

#add state population data
UCR_arrest_totals_and_rates_with_pop <- left_join(UCR_arrest_totals_and_rates, ACS_state_pops, by = c("NAME", "year"))

#rearrange column order, drop unnecessary columns
UCR_arrest_totals_and_rates_with_pop <- UCR_arrest_totals_and_rates_with_pop %>% 
  ungroup() %>% 
  select(-STNAME, -STATE) %>% 
  select(NAME, year, GEOID, total_popE, white_popE, white_popM, black_popE, black_popM, 1:15)


```

```{r add legalization status}
#load legalization status spreadsheets
legalization_status_one_equals_any_legalization_in_year <- read_excel("Marijuana_Legalization_Status_One_Equals_Any_Legalization_In_Year.xlsx") %>% 
  gather(year, legalization_status_one_equals_any_legalization_in_year, -NAME)

legalization_status_one_equals_legalization_entire_year <- read_excel("Marijuana_Legalization_Status_One_Equals_Legalization_Entire_Year.xlsx") %>% 
  gather(year, legalization_status_one_equals_entire_year, -NAME)

legalization_status_fraction_of_year_legalized <- read_excel("Marijuana_Legalization_Status_Fraction_Of_Year_Legalized.xlsx") %>% 
  gather(year, legalization_status_fraction_of_year_legalized, -NAME)

UCR_arrest_totals_and_rates_with_pop <- UCR_arrest_totals_and_rates_with_pop %>% 
  left_join(legalization_status_one_equals_any_legalization_in_year, by = c("NAME", "year")) %>% 
  left_join(legalization_status_one_equals_legalization_entire_year, by = c("NAME", "year")) %>% 
  left_join(legalization_status_fraction_of_year_legalized, by = c("NAME", "year"))
```

```{r convert columns to correct types and rename}
UCR_arrest_totals_and_rates_with_pop <- UCR_arrest_totals_and_rates_with_pop %>% 
  rename(State = NAME,
         Year = year) %>% 
  mutate(State = as.factor(State),
         Year = as.factor(Year),
         GEOID = as.factor(GEOID))

#remove Florida, as it has no UCR data
UCR_arrest_totals_and_rates_with_pop <- UCR_arrest_totals_and_rates_with_pop %>% 
  filter(!State == "Florida")
```

```{r calculate arrest rates for each race}
UCR_arrest_totals_and_rates_with_pop <- UCR_arrest_totals_and_rates_with_pop %>% 
  mutate(total_arrest_rate = total_arrests_race_data / total_popE) %>% 
  mutate(marijuana_arrest_rate = total_marijuana_arrests_race_data / total_popE) %>% 
  mutate(white_arrest_rate = total_White_arrests / white_popE) %>% 
  mutate(black_arrest_rate = total_African_American_arrests / black_popE) %>% 
  mutate(white_marijuana_arrest_rate = total_White_marijuana_arrests / white_popE) %>% 
  mutate(black_marijuana_arrest_rate = total_African_American_marijuana_arrests / black_popE) %>% 
  mutate(white_non_drug_misdemeanor_arrest_rate = total_White_non_drug_misdemeanor_arrests / white_popE) %>% 
  mutate(black_non_drug_misdemeanor_arrest_rate = total_African_American_non_drug_misdemeanor_arrests / black_popE)
```

```{r conduct difference in differences}

model <- lm(marijuana_arrest_rate ~ legalization_status_fraction_of_year_legalized, data = UCR_arrest_totals_and_rates_with_pop)
summary(model)
```

```{r graph changes in marijuana arrest rate}

UCR_arrest_totals_and_rates_with_pop %>% 
  ggplot(aes(x = Year, y = marijuana_arrest_rate, group = State)) +
  geom_line() +
  facet_wrap(~State)

UCR_arrest_totals_and_rates_with_pop %>% 
  filter(State %in% c("California", "Washington", "Oregon", "Colorado", "District of Columbia", "Alaska")) %>% 
  ggplot(aes(x = Year, y = marijuana_arrest_rate, group = State)) +
  geom_line() +
  facet_wrap(~State)


UCR_arrest_totals_and_rates_with_pop %>% 
  filter(State == "Colorado")
```















